<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lessons Learned</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%23566a89'%3E%3Crect width='512' height='512' fill='%23566a89' rx='100'/%3E%3Cpath d='M360 140H152c-22.09 0-40 17.91-40 40v216c0 13.26 10.75 24 24 24h240c13.25 0 24-10.74 24-24V164C400 150.7 382.1 140 360 140z' fill='%23fff'/%3E%3Cpath d='M152 180h208v24H152zM152 230h208v24H152zM152 280h140v24H152z' fill='%23566a89' opacity='0.7'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%23566a89'%3E%3Crect width='512' height='512' fill='%23566a89' rx='100'/%3E%3Cpath d='M360 140H152c-22.09 0-40 17.91-40 40v216c0 13.26 10.75 24 24 24h240c13.25 0 24-10.74 24-24V164C400 150.7 382.1 140 360 140z' fill='%23fff'/%3E%3Cpath d='M152 180h208v24H152zM152 230h208v24H152zM152 280h140v24H152z' fill='%23566a89' opacity='0.7'/%3E%3C/svg%3E">

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&family=Song+Myung&family=Nanum+Myeongjo&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/iropke-batang-font@1.0.2/font.css">

    <style>
        :root {
            --bg-body: #f8f8fa;
            --bg-sidebar: #fdfdfd;
            --text-main: #3d3d3d;      
            --text-sub: #6e6e6e;       
            --text-light: #9ca3af;     
            --accent-color: #566a89;
            --border-color: #ebebeb;
            --btn-hover: #475872;
            --font-ui: 'Pretendard Variable', sans-serif;
            --sidebar-width: 280px;
            /* ì•„ì´í° ì•ˆì „ ì˜ì—­ ë³€ìˆ˜ */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-ui);
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            /* ëª¨ë°”ì¼ ì£¼ì†Œì°½ ë°€ë¦¼ ë°©ì§€ */
            min-height: -webkit-fill-available;
            display: flex;
            overflow: hidden;
            font-size: 16px;
        }

        /* --- Sidebar --- */
        .sidebar { 
            width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-color); 
            display: flex; flex-direction: column; padding: 40px 20px; flex-shrink: 0; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            /* ì•„ì´í° í•˜ë‹¨ ì˜ì—­ ëŒ€ì‘ */
            padding-bottom: calc(20px + var(--safe-bottom));
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute; left: 0; top: 0; bottom: 0;
                transform: translateX(-100%); width: 85%;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                padding-top: calc(20px + var(--safe-top));
            }
            .sidebar.open { transform: translateX(0); }
        }

        .btn-new {
            background-color: #475569; color: white; border: none; padding: 14px; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 20px; width: 100%;
            box-shadow: 0 4px 12px rgba(71, 85, 105, 0.15);
        }

        .nav-list { list-style: none; flex: 1; overflow-y: auto; margin-bottom: 20px; }
        .nav-item { padding: 12px; border-radius: 8px; font-size: 15px; color: var(--text-sub); margin-bottom: 4px; display: flex; justify-content: space-between; cursor: pointer; }
        .nav-item:hover { background-color: #f3f4f6; }
        .nav-item.active { background-color: #edf2f7; color: var(--accent-color); font-weight: 700; }
        .nav-sub { padding-left: 28px; font-size: 14px; }

        .sidebar-bottom { border-top: 1px solid #f5f5f5; padding-top: 20px; margin-top: 10px; }
        .btn-setting-row {
            display: flex; align-items: center; gap: 8px; width: 100%; padding: 12px; 
            background: none; border: none; color: #555; font-size: 15px; cursor: pointer;
        }
        .copyright { margin-top: 5px; text-align: center; font-size: 11px; color: #ccc; }

        /* --- Lock Screen UI (Sidebar) --- */
        #sidebarLockArea { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .lock-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 16px; font-family: var(--font-ui); -webkit-appearance: none; }
        .btn-unlock { width: 100%; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* --- Main Area --- */
        .main { flex: 1; background: var(--bg-body); position: relative; overflow: hidden; display: flex; flex-direction: column; width: 100%; }
        
        /* ì ê¸ˆ ìƒíƒœ ë©”ì¸ í™”ë©´ ì»¤ë²„ */
        #mainLockCover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8f8fa; z-index: 900;
            display: flex; align-items: center; justify-content: center;
            color: #999; font-size: 14px;
        }

        .mobile-header {
            display: none; height: 56px; align-items: center; padding: 0 15px; 
            background: white; border-bottom: 1px solid #eee; flex-shrink: 0;
            /* ì•„ì´í° ë…¸ì¹˜ ì˜ì—­ë§Œí¼ ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
            padding-top: var(--safe-top);
            height: calc(56px + var(--safe-top));
        }
        .btn-menu { border: none; background: none; font-size: 24px; cursor: pointer; color: #333; padding: 5px; }
        .header-title { margin-left: 10px; font-weight: 700; font-size: 17px; }

        @media (max-width: 768px) { .mobile-header { display: flex; } }

        /* --- List View --- */
        #listView { 
            padding: 20px; overflow-y: auto; height: 100%; -webkit-overflow-scrolling: touch; 
            /* í•˜ë‹¨ ì•ˆì „ ì˜ì—­ í™•ë³´ */
            padding-bottom: calc(30px + var(--safe-bottom));
        }

        .list-header { margin-bottom: 20px; font-size: 22px; font-weight: 700; color: var(--text-main); }
        .card { background: white; padding: 22px; border-radius: 16px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); cursor: pointer; border: 1px solid white;}
        .card:active { transform: scale(0.98); background: #fafafa; }
        .card-meta { font-size: 13px; color: var(--text-light); margin-bottom: 8px; display: flex; gap: 8px; }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: #333; }
        .card-preview { font-size: 15px; color: var(--text-sub); line-height: 1.5; max-height: 46px; overflow: hidden; }

        /* --- Read/Editor View --- */
        .view-container { 
            display: none; height: 100%; background: white; 
            padding: 20px; overflow-y: auto; position: absolute; top: 0; left: 0; width: 100%; z-index: 50; 
            /* í•˜ë‹¨ ì•ˆì „ ì˜ì—­ í™•ë³´ */
            padding-bottom: calc(40px + var(--safe-bottom));
        }
        
        @media (max-width: 768px) { 
            .view-container { 
                top: calc(56px + var(--safe-top)); 
                height: calc(100% - (56px + var(--safe-top))); 
            } 
        }

        .btn-back { font-size: 16px; padding: 12px 0; border:none; background:none; color: var(--text-sub); margin-bottom: 5px; display:flex; align-items: center; cursor: pointer; }
        
        #titleInput { width: 100%; border: none; font-size: 24px; font-weight: 700; margin-bottom: 20px; padding: 15px 0; border-bottom: 1px solid #eee; border-radius: 0; font-family: var(--font-ui); outline: none; background: transparent; }
        
        /* [ì¤‘ìš”] ìŠ¤íƒ€ì¼ ê¹¨ì§ ë°©ì§€: ì—ë””í„° ë° ë·°ì–´ ê³µí†µ ìŠ¤íƒ€ì¼ */
        #contentInput, .read-content { 
            font-size: 17px; line-height: 1.7; min-height: 300px; outline: none; 
            color: #333; font-family: var(--font-ui); 
            white-space: pre-wrap; word-break: break-word;
        }
        /* êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ ê°•ì œ ì§€ì • */
        #contentInput hr, .read-content hr, hr {
            border: 0; border-top: 1px solid #e0e0e0; margin: 25px 0;
        }
        /* ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        #contentInput img, .read-content img { max-width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 15px 0; }

        .read-category { font-size: 13px; color: var(--accent-color); font-weight: 600; background: #eff2f6; padding: 4px 10px; border-radius: 12px; display: inline-block; margin-bottom: 10px; }
        .read-title { font-size: 26px; font-weight: 700; margin-bottom: 10px; line-height: 1.3; color: #333; }
        
        .toolbar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none; align-items: center; }
        .toolbar::-webkit-scrollbar { display: none; }
        .tool-chip button { background: #f3f4f6; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn-line-add { font-size: 13px; font-weight: 600; color: #555; background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; cursor: pointer; }

        .editor-actions { padding: 20px 0; display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; border-top: 1px solid #f9f9f9;}
        .btn { padding: 14px 20px; border-radius: 10px; border:none; font-size: 15px; font-weight: 600; cursor: pointer; }
        .btn-save { background: var(--accent-color); color: white; width: 100%; }
        .btn-cancel { background: #f0f0f0; color: #333; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal { background: white; width: 90%; max-width: 420px; padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .btn-close-modal { border:none; background:none; font-size: 20px; padding: 5px; cursor: pointer; color: #888; }
        
        .cat-list { max-height: 250px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px; padding: 5px; }
        .cat-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f9f9f9; align-items: center; font-size: 15px; }
        .cat-row:last-child { border-bottom: none; }
        .cat-btn-group { display: flex; gap: 5px; }
        .btn-cat-action { font-size: 12px; color: #888; background: none; border: 1px solid #eee; border-radius: 4px; padding: 4px 8px; cursor: pointer; }
        
        .modal-input-area { display: flex; gap: 8px; }
        .input-new-cat { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: var(--font-ui); outline: none; -webkit-appearance: none;}
        .btn-add-cat { padding: 0 18px; background: var(--accent-color); color: white; border:none; border-radius: 8px; white-space: nowrap; cursor: pointer; }

        .sidebar-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 90; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <button class="btn-menu" onclick="toggleSidebar()">â˜°</button>
        <div class="header-title">Lessons Learned</div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        
        <div id="sidebarLockArea">
            <h3 style="margin-bottom:20px; color:#555;">Locked</h3>
            <input type="password" id="unlockCode" class="lock-input" placeholder="ì½”ë“œ ì…ë ¥" onkeyup="if(window.event.keyCode==13){checkCode()}">
            <button class="btn-unlock" onclick="checkCode()">ì ‘ì†</button>
            </div>

        <div id="sidebarContent" style="display:none; flex-direction:column; height:100%;">
            <button class="btn-new" onclick="createNewPost()">+ ê¸°ë¡í•˜ê¸°</button>
            <ul class="nav-list" id="sidebarNav"></ul>

            <button class="btn-setting-row" onclick="openCategoryModal()">
                <span>âš™ï¸ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</span>
            </button>
            <div class="sidebar-bottom">
                <div class="copyright">Powered by DWG Inc.</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div id="mainLockCover">
            <div>ğŸ”’ ì™¼í¸ì— ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        </div>

        <div id="listView">
            <div class="list-header" id="listTitle">ì „ì²´ ë³´ê¸°</div>
            <div class="card-container" id="cardContainer"></div>
            <div id="emptyListState" style="display:none; text-align:center; color:#ccc; margin-top:100px;">
                ê¸°ë¡ëœ ì´ì•¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <div id="readView" class="view-container">
            <div class="editor-top" style="display:flex; justify-content:space-between;">
                <button class="btn-back" onclick="goBackToList()">â† ë’¤ë¡œê°€ê¸°</button>
            </div>
            <div class="read-category" id="readCategory"></div>
            <div class="read-title" id="readTitle"></div>
            <div class="read-meta" id="readMeta" style="color:#999; font-size:13px; margin-bottom:20px;"></div>
            <hr>
            <div id="readImageContainer" style="display:none; margin:15px 0;"><img id="readImage" src=""></div>
            <div class="read-content" id="readContent"></div>
            <div class="editor-actions">
                <button class="btn btn-cancel" onclick="downloadEntryHTML()">íŒŒì¼ì €ì¥</button>
                <button class="btn btn-cancel" onclick="deleteCurrentEntry()">ì‚­ì œ</button>
                <button class="btn btn-save" onclick="editCurrentEntry()">ìˆ˜ì •</button>
            </div>
        </div>

        <div id="editorView" class="view-container">
            <div class="editor-top" style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button class="btn-back" onclick="goBackToList()">ì·¨ì†Œ</button>
                <div style="display:flex; align-items:center;">
                    <select id="categorySelect" style="padding:8px; border:1px solid #ddd; border-radius:6px; outline:none; background:white;"></select>
                </div>
            </div>

            <div class="toolbar">
                <div class="tool-chip"><button onclick="document.getElementById('imgInput').click()">ğŸ“· ì‚¬ì§„</button></div>
                <div class="tool-chip"><input type="color" id="colorInput" onchange="execCmd('foreColor', this.value)" style="width:30px; height:30px; border:none; background:none; cursor:pointer;"></div>
                <div class="tool-chip"><button class="btn-line-add" onclick="insertSeparator()">â€• êµ¬ë¶„ì„ </button></div>
            </div>
            <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="handleImage(this)">

            <input type="text" id="titleInput" placeholder="ì œëª©">
            
            <div id="previewBox" class="preview-box" style="display:none; position:relative; margin-bottom:15px;">
                <img id="imgPreview" src="" style="max-width:100%; border-radius:8px;">
                <button onclick="removeImage()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer;">X</button>
            </div>

            <div id="contentInput" contenteditable="true" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>

            <div class="editor-actions">
                <button class="btn btn-save" onclick="saveEntry()" style="width:100%;">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3>
                <button class="btn-close-modal" onclick="closeModal()">âœ•</button>
            </div>
            <div class="cat-list" id="catManagerList"></div>
            <div class="modal-input-area">
                <input type="text" id="newCatName" class="input-new-cat" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬">
                <button class="btn-add-cat" onclick="addRootCategory()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. ì ê¸ˆ ë° ë°ì´í„° ì„¤ì • ---
        const SECRET_CODE = "1320"; // ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
        let isLocked = true;

        let diaries = JSON.parse(localStorage.getItem('myDiaries')) || [];
        let categories = JSON.parse(localStorage.getItem('myCategories')) || [
            { id: 'def_1', name: 'ì¼ìƒ', parentId: null },
            { id: 'def_2', name: 'ìƒê°', parentId: null }
        ];

        let currentFilterCat = 'ALL';
        let editingId = null; 
        let currentImgData = null;

        // --- 1. ì ê¸ˆ ê¸°ëŠ¥ ---
        function checkCode() {
            const input = document.getElementById('unlockCode').value;
            if(input === SECRET_CODE) {
                isLocked = false;
                document.getElementById('sidebarLockArea').style.display = 'none';
                document.getElementById('sidebarContent').style.display = 'flex';
                document.getElementById('mainLockCover').style.display = 'none';
                renderSidebar();
                renderCardList('ALL');
            } else {
                alert('ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                document.getElementById('unlockCode').value = '';
            }
        }

        // --- 2. ê¸°ë³¸ UI ë™ì‘ ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.querySelector('.sidebar-overlay');
            if(sb.classList.contains('open')) {
                sb.classList.remove('open');
                ov.style.display = 'none';
            } else {
                sb.classList.add('open');
                ov.style.display = 'block';
            }
        }

        function switchView(mode) {
            document.querySelectorAll('.view-container').forEach(el => el.style.display = 'none');
            document.getElementById('listView').style.display = 'none';
            
            if(mode === 'list') {
                document.getElementById('listView').style.display = 'block';
            } else {
                document.getElementById(mode + 'View').style.display = 'block';
            }
            // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ë‹«ê¸°
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').style.display = 'none';
        }

        function goBackToList() { switchView('list'); }

        // --- 3. ì—ë””í„° ê¸°ëŠ¥ ---
        function execCmd(cmd, val) { 
            document.execCommand(cmd, false, val); 
        }
        function insertSeparator() { 
            const hrHtml = '<hr style="border:0; border-top:1px solid #e0e0e0; margin:20px 0;">';
            document.execCommand('insertHTML', false, hrHtml); 
        }

        function createNewPost() {
            editingId = null; currentImgData = null;
            document.getElementById('titleInput').value = ''; 
            document.getElementById('contentInput').innerHTML = ''; 
            removeImage(); updateCategorySelectOptions();
            switchView('editor');
        }

        function saveEntry() {
            const title = document.getElementById('titleInput').value.trim();
            if(!title) return alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            const now = new Date();
            const entry = {
                id: editingId || now.getTime(),
                timestamp: now.getTime(),
                title: title,
                content: document.getElementById('contentInput').innerHTML, 
                categoryId: document.getElementById('categorySelect').value,
                image: currentImgData
            };

            if(editingId) {
                const idx = diaries.findIndex(d => d.id === editingId);
                diaries[idx] = entry;
            } else {
                diaries.push(entry);
                editingId = entry.id;
            }
            localStorage.setItem('myDiaries', JSON.stringify(diaries));
            renderSidebar();
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            openViewer(entry.id);
        }

        function openViewer(id) {
            const entry = diaries.find(d => d.id === id);
            if(!entry) return;
            editingId = entry.id;

            const cat = categories.find(c => c.id === entry.categoryId);
            document.getElementById('readCategory').innerText = cat ? cat.name : "ë¯¸ë¶„ë¥˜";
            document.getElementById('readTitle').innerText = entry.title;
            
            const dObj = new Date(entry.timestamp);
            document.getElementById('readMeta').innerText = dObj.toLocaleDateString() + ' ' + dObj.toLocaleTimeString();
            document.getElementById('readContent').innerHTML = entry.content;
            
            if(entry.image) {
                document.getElementById('readImage').src = entry.image;
                document.getElementById('readImageContainer').style.display = 'block';
            } else {
                document.getElementById('readImageContainer').style.display = 'none';
            }
            switchView('read');
        }

        function editCurrentEntry() {
            const entry = diaries.find(d => d.id === editingId);
            if(!entry) return;
            document.getElementById('titleInput').value = entry.title;
            document.getElementById('contentInput').innerHTML = entry.content;
            updateCategorySelectOptions();
            document.getElementById('categorySelect').value = entry.categoryId || '';
            if(entry.image) {
                currentImgData = entry.image;
                document.getElementById('imgPreview').src = entry.image;
                document.getElementById('previewBox').style.display = 'block';
            }
            switchView('editor');
        }

        function deleteCurrentEntry() {
            if(confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) {
                diaries = diaries.filter(d => d.id !== editingId);
                localStorage.setItem('myDiaries', JSON.stringify(diaries));
                renderSidebar(); renderCardList('ALL'); goBackToList();
            }
        }

        // [ë°±ì—… ê¸°ëŠ¥] íŒŒì¼ ì €ì¥ (ìŠ¤íƒ€ì¼ ë‚´ì¥í˜•)
        function downloadEntryHTML() {
            const entry = diaries.find(d => d.id === editingId);
            if(!entry) return;

            const htmlContent = `
            <!DOCTYPE html>
            <html lang="ko">
            <head>
                <meta charset="UTF-8">
                <title>${entry.title}</title>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
                <style>
                    body { font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.8; color: #333; }
                    h1 { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 10px; }
                    .meta { color: #888; font-size: 14px; margin-bottom: 40px; }
                    .content { white-space: pre-wrap; word-break: break-word; }
                    hr { border: 0; border-top: 1px solid #e0e0e0; margin: 30px 0; }
                    img { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px 0; }
                </style>
            </head>
            <body>
                <h1>${entry.title}</h1>
                <div class="meta">${new Date(entry.timestamp).toLocaleString()}</div>
                <div class="content">
                    ${entry.image ? `<img src="${entry.image}"><br>` : ''}
                    ${entry.content}
                </div>
            </body>
            </html>`;
            
            const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${entry.title}.html`;
            a.click();
        }

        // --- 4. ë Œë”ë§ í—¬í¼ ---
        function renderSidebar() {
            if(isLocked) return; 
            const nav = document.getElementById('sidebarNav'); nav.innerHTML = '';
            addNavItem(nav, 'ì „ì²´ ë³´ê¸°', diaries.length, 'ALL');
            
            categories.filter(c => !c.parentId).forEach(root => {
                const count = diaries.filter(d => d.categoryId === root.id).length;
                addNavItem(nav, root.name, count, root.id);
                
                categories.filter(c => c.parentId === root.id).forEach(child => {
                    const cCount = diaries.filter(d => d.categoryId === child.id).length;
                    addNavItem(nav, `â”” ${child.name}`, cCount, child.id, true);
                });
            });
        }

        function addNavItem(parent, name, count, id, isSub=false) {
            const li = document.createElement('li');
            li.className = `nav-item ${isSub?'nav-sub':''} ${currentFilterCat===id?'active':''}`;
            li.innerHTML = `<span>${name}</span><span style="font-size:11px; color:#ccc">${count}</span>`;
            li.onclick = () => { currentFilterCat = id; renderSidebar(); renderCardList(id); toggleSidebar(); switchView('list'); };
            parent.appendChild(li);
        }

        function renderCardList(catId) {
            if(isLocked) return;
            const container = document.getElementById('cardContainer'); container.innerHTML = '';
            const catName = catId==='ALL' ? "ì „ì²´ ë³´ê¸°" : (categories.find(c=>c.id===catId)||{}).name;
            document.getElementById('listTitle').innerText = catName || "ëª©ë¡";
            
            let list = catId==='ALL' ? diaries : diaries.filter(d => d.categoryId === catId);
            list.sort((a,b) => b.timestamp - a.timestamp);
            document.getElementById('emptyListState').style.display = list.length?'none':'block';
            
            list.forEach(d => {
                const dateStr = new Date(d.timestamp).toLocaleDateString();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = d.content;
                const cleanText = tempDiv.textContent || "";
                
                const card = document.createElement('div'); card.className = 'card';
                card.onclick = () => openViewer(d.id);
                card.innerHTML = `<div class="card-meta"><span>${dateStr}</span></div><div class="card-title">${d.title}</div><div class="card-preview">${cleanText}</div>`;
                container.appendChild(card);
            });
        }

        function handleImage(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxW = 800; let w=img.width, h=img.height;
                    if(w>maxW){ h*=maxW/w; w=maxW; }
                    canvas.width=w; canvas.height=h;
                    canvas.getContext('2d').drawImage(img,0,0,w,h);
                    currentImgData = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('imgPreview').src = currentImgData;
                    document.getElementById('previewBox').style.display = 'block';
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file); input.value = '';
        }
        function removeImage() { currentImgData = null; document.getElementById('previewBox').style.display = 'none'; }

        // --- 5. ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ---
        function updateCategorySelectOptions() {
            const sel = document.getElementById('categorySelect'); sel.innerHTML = '';
            categories.filter(c=>!c.parentId).forEach(r => {
                const opt = document.createElement('option'); opt.value = r.id; opt.innerText = r.name; sel.appendChild(opt);
                categories.filter(c=>c.parentId===r.id).forEach(ch => {
                    const sub = document.createElement('option'); sub.value = ch.id; sub.innerText = `  â”” ${ch.name}`; sel.appendChild(sub);
                });
            });
        }
        
        function openCategoryModal() { document.getElementById('modalOverlay').style.display = 'flex'; renderCatManager(); }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; renderSidebar(); updateCategorySelectOptions(); }
        
        function renderCatManager() {
            const list = document.getElementById('catManagerList'); list.innerHTML = '';
            
            categories.filter(c=>!c.parentId).forEach(r => {
                const row = document.createElement('div'); row.className = 'cat-row';
                row.innerHTML = `
                    <strong>${r.name}</strong>
                    <div class="cat-btn-group">
                        <button class="btn-cat-action" onclick="addChildCat('${r.id}')">ì†Œë¶„ë¥˜</button>
                        <button class="btn-cat-action" onclick="editCat('${r.id}')">ìˆ˜ì •</button>
                        <button class="btn-cat-action" onclick="delCat('${r.id}')">ì‚­ì œ</button>
                    </div>`;
                list.appendChild(row);
                
                categories.filter(c=>c.parentId===r.id).forEach(ch => {
                    const sub = document.createElement('div'); sub.className = 'cat-row'; sub.style.paddingLeft='20px';
                    sub.innerHTML = `
                        <span style="color:#666">â”” ${ch.name}</span>
                        <div class="cat-btn-group">
                            <button class="btn-cat-action" onclick="editCat('${ch.id}')">ìˆ˜ì •</button>
                            <button class="btn-cat-action" onclick="delCat('${ch.id}')">ì‚­ì œ</button>
                        </div>`;
                    list.appendChild(sub);
                });
            });
        }

        function addRootCategory() {
            const name = document.getElementById('newCatName').value.trim();
            if(name) { categories.push({id:'cat_'+Date.now(), name:name, parentId:null}); saveCat(); document.getElementById('newCatName').value=''; }
        }
        function addChildCat(parentId) {
            const name = prompt('ì†Œë¶„ë¥˜ ì´ë¦„:');
            if(name) { categories.push({id:'cat_'+Date.now(), name:name, parentId:parentId}); saveCat(); }
        }
        function editCat(id) {
            const cat = categories.find(c=>c.id===id);
            const newName = prompt('ìˆ˜ì •í•  ì´ë¦„:', cat.name);
            if(newName) { cat.name = newName; saveCat(); }
        }
        function delCat(id) {
            if(confirm('ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí• ê¹Œìš”? (í¬í•¨ëœ ê¸€ì€ ë¯¸ë¶„ë¥˜ê°€ ë©ë‹ˆë‹¤)')) {
                categories = categories.filter(c => c.id !== id && c.parentId !== id);
                saveCat();
            }
        }
        function saveCat() {
            localStorage.setItem('myCategories', JSON.stringify(categories));
            renderCatManager();
        }
    </script>
</body>
</html>