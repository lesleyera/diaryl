<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lessons Learned</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&family=Song+Myung&family=Nanum+Myeongjo&family=Nanum+Pen+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/iropke-batang-font@1.0.2/font.css">

    <style>
        :root {
            --bg-body: #f8f8fa;
            --bg-sidebar: #fdfdfd;
            --text-main: #3d3d3d;      
            --text-sub: #6e6e6e;       
            --text-light: #9ca3af;     
            --accent-color: #566a89;
            --border-color: #ebebeb;
            --btn-hover: #475872;
            --font-ui: 'Pretendard Variable', sans-serif;
            --sidebar-width: 280px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-ui);
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 16px;
        }

        /* --- Sidebar --- */
        .sidebar { 
            width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-color); 
            display: flex; flex-direction: column; padding: 40px 20px; flex-shrink: 0; 
            transition: transform 0.3s ease;
            z-index: 100;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute; left: 0; top: 0; bottom: 0;
                transform: translateX(-100%); width: 85%;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .sidebar.open { transform: translateX(0); }
        }

        .btn-new {
            background-color: #475569; color: white; border: none; padding: 14px; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 20px; width: 100%;
            box-shadow: 0 4px 12px rgba(71, 85, 105, 0.15);
        }

        .nav-list { list-style: none; flex: 1; overflow-y: auto; margin-bottom: 20px; }
        .nav-item { padding: 12px; border-radius: 8px; font-size: 15px; color: var(--text-sub); margin-bottom: 4px; display: flex; justify-content: space-between; cursor: pointer; }
        .nav-item:hover { background-color: #f3f4f6; }
        .nav-item.active { background-color: #edf2f7; color: var(--accent-color); font-weight: 700; }
        .nav-sub { padding-left: 28px; font-size: 14px; }

        .sidebar-bottom { border-top: 1px solid #f5f5f5; padding-top: 20px; margin-top: 10px; }
        .btn-setting-row {
            display: flex; align-items: center; gap: 8px; width: 100%; padding: 12px; 
            background: none; border: none; color: #555; font-size: 15px; cursor: pointer;
        }
        .copyright { margin-top: 5px; text-align: center; font-size: 11px; color: #ccc; }

        /* --- Lock Screen UI (Sidebar) --- */
        #sidebarLockArea { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .lock-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 16px; font-family: var(--font-ui); }
        .btn-unlock { width: 100%; padding: 12px; background: var(--accent-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* --- Main Area --- */
        .main { flex: 1; background: var(--bg-body); position: relative; overflow: hidden; display: flex; flex-direction: column; width: 100%; }
        
        /* Ïû†Í∏à ÏÉÅÌÉú Î©îÏù∏ ÌôîÎ©¥ Ïª§Î≤Ñ */
        #mainLockCover {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8f8fa; z-index: 900;
            display: flex; align-items: center; justify-content: center;
            color: #999; font-size: 14px;
        }

        .mobile-header {
            display: none; height: 50px; align-items: center; padding: 0 15px; 
            background: white; border-bottom: 1px solid #eee; flex-shrink: 0;
        }
        .btn-menu { border: none; background: none; font-size: 24px; cursor: pointer; color: #333; }
        .header-title { margin-left: 10px; font-weight: 700; font-size: 16px; }

        @media (max-width: 768px) { .mobile-header { display: flex; } }

        /* --- List View --- */
        #listView { padding: 30px; overflow-y: auto; height: 100%; -webkit-overflow-scrolling: touch; }
        @media (max-width: 768px) { #listView { padding: 15px; } }

        .list-header { margin-bottom: 20px; font-size: 20px; font-weight: 700; color: var(--text-main); }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); cursor: pointer; }
        .card-meta { font-size: 12px; color: var(--text-light); margin-bottom: 8px; display: flex; gap: 8px; }
        .card-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; color: #333; }
        .card-preview { font-size: 14px; color: var(--text-sub); line-height: 1.5; max-height: 44px; overflow: hidden; }

        /* --- Read/Editor View --- */
        .view-container { display: none; height: 100%; background: white; padding: 40px; overflow-y: auto; position: absolute; top: 0; left: 0; width: 100%; z-index: 50; }
        @media (max-width: 768px) { .view-container { padding: 20px; top: 50px; height: calc(100% - 50px); } }

        .btn-back { font-size: 15px; padding: 10px 0; border:none; background:none; color: var(--text-sub); margin-bottom: 10px; display:flex; align-items: center; cursor: pointer; }
        
        #titleInput { width: 100%; border: none; font-size: 24px; font-weight: 700; margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #eee; border-radius: 0; font-family: var(--font-ui); outline: none; }
        
        /* [Ï§ëÏöî] Ïä§ÌÉÄÏùº Íπ®Ïßê Î∞©ÏßÄ: ÏóêÎîîÌÑ∞ Î∞è Î∑∞Ïñ¥ Í≥µÌÜµ Ïä§ÌÉÄÏùº */
        #contentInput, .read-content { 
            font-size: 16px; line-height: 1.8; min-height: 300px; outline: none; 
            color: #333; font-family: var(--font-ui); 
            white-space: pre-wrap; word-break: break-word;
        }
        /* Íµ¨Î∂ÑÏÑ† Ïä§ÌÉÄÏùº Í∞ïÏ†ú ÏßÄÏ†ï */
        #contentInput hr, .read-content hr, hr {
            border: 0; border-top: 1px solid #e0e0e0; margin: 20px 0;
        }
        /* Ïù¥ÎØ∏ÏßÄ Ïä§ÌÉÄÏùº */
        #contentInput img, .read-content img { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 10px 0; }

        .read-category { font-size: 13px; color: var(--accent-color); font-weight: 600; background: #eff2f6; padding: 4px 10px; border-radius: 12px; display: inline-block; margin-bottom: 10px; }
        .read-title { font-size: 26px; font-weight: 700; margin-bottom: 10px; line-height: 1.3; color: #333; }
        
        .toolbar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none; align-items: center; }
        .toolbar::-webkit-scrollbar { display: none; }
        .tool-chip button { background: #f3f4f6; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .btn-line-add { font-size: 13px; font-weight: 600; color: #555; background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; cursor: pointer; }

        .editor-actions { padding: 20px 0; display: flex; justify-content: flex-end; gap: 10px; padding-bottom: 50px; border-top: 1px solid #f5f5f5; margin-top: 30px;}
        .btn { padding: 12px 20px; border-radius: 8px; border:none; font-size: 15px; font-weight: 600; cursor: pointer; }
        .btn-save { background: var(--accent-color); color: white; }
        .btn-cancel { background: #f0f0f0; color: #333; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal { background: white; width: 90%; max-width: 420px; padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .btn-close-modal { border:none; background:none; font-size: 20px; padding: 5px; cursor: pointer; color: #888; }
        
        .cat-list { max-height: 250px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px; padding: 5px; }
        .cat-row { display: flex; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #f9f9f9; align-items: center; font-size: 14px; }
        .cat-row:last-child { border-bottom: none; }
        .cat-btn-group { display: flex; gap: 5px; }
        .btn-cat-action { font-size: 12px; color: #888; background: none; border: 1px solid #eee; border-radius: 4px; padding: 3px 6px; cursor: pointer; }
        .btn-cat-action:hover { color: var(--accent-color); border-color: var(--accent-color); }
        
        .modal-input-area { display: flex; gap: 8px; }
        .input-new-cat { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: var(--font-ui); outline: none; }
        .btn-add-cat { padding: 0 15px; background: var(--accent-color); color: white; border:none; border-radius: 8px; white-space: nowrap; cursor: pointer; }

        .sidebar-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 90; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <button class="btn-menu" onclick="toggleSidebar()">‚ò∞</button>
        <div class="header-title">Lessons Learned</div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        
        <div id="sidebarLockArea">
            <h3 style="margin-bottom:20px; color:#555;">Locked</h3>
            <input type="password" id="unlockCode" class="lock-input" placeholder="ÏΩîÎìú ÏûÖÎ†•" onkeyup="if(window.event.keyCode==13){checkCode()}">
            <button class="btn-unlock" onclick="checkCode()">Ï†ëÏÜç</button>
        </div>

        <div id="sidebarContent" style="display:none; flex-direction:column; height:100%;">
            <button class="btn-new" onclick="createNewPost()">+ Í∏∞Î°ùÌïòÍ∏∞</button>
            <ul class="nav-list" id="sidebarNav"></ul>

            <button class="btn-setting-row" onclick="openCategoryModal()">
                <span>‚öôÔ∏è Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨</span>
            </button>
            <div class="sidebar-bottom">
                <div class="copyright">Powered by DWG Inc.</div>
            </div>
        </div>
    </aside>

    <main class="main">
        <div id="mainLockCover">
            <div>üîí ÏôºÌé∏Ïóê ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</div>
        </div>

        <div id="listView">
            <div class="list-header" id="listTitle">Ï†ÑÏ≤¥ Î≥¥Í∏∞</div>
            <div class="card-container" id="cardContainer"></div>
            <div id="emptyListState" style="display:none; text-align:center; color:#ccc; margin-top:100px;">
                Í∏∞Î°ùÎêú Ïù¥ÏïºÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.
            </div>
        </div>

        <div id="readView" class="view-container">
            <div class="editor-top" style="display:flex; justify-content:space-between;">
                <button class="btn-back" onclick="goBackToList()">‚Üê Îí§Î°úÍ∞ÄÍ∏∞</button>
            </div>
            <div class="read-category" id="readCategory"></div>
            <div class="read-title" id="readTitle"></div>
            <div class="read-meta" id="readMeta" style="color:#999; font-size:13px; margin-bottom:20px;"></div>
            <hr>
            <div id="readImageContainer" style="display:none; margin:15px 0;"><img id="readImage" src=""></div>
            <div class="read-content" id="readContent"></div>
            <div class="editor-actions">
                <button class="btn btn-cancel" onclick="downloadEntryHTML()">ÌååÏùºÏ†ÄÏû•</button>
                <button class="btn btn-cancel" onclick="deleteCurrentEntry()">ÏÇ≠Ï†ú</button>
                <button class="btn btn-save" onclick="editCurrentEntry()">ÏàòÏ†ï</button>
            </div>
        </div>

        <div id="editorView" class="view-container">
            <div class="editor-top" style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button class="btn-back" onclick="goBackToList()">Ï∑®ÏÜå</button>
                <div style="display:flex; align-items:center;">
                    <select id="categorySelect" style="padding:8px; border:1px solid #ddd; border-radius:6px; outline:none;"></select>
                </div>
            </div>

            <div class="toolbar">
                <div class="tool-chip"><button onclick="document.getElementById('imgInput').click()">üì∑ ÏÇ¨ÏßÑ</button></div>
                <div class="tool-chip"><input type="color" id="colorInput" onchange="execCmd('foreColor', this.value)" style="width:30px; height:30px; border:none; background:none; cursor:pointer;"></div>
                <div class="tool-chip"><button class="btn-line-add" onclick="insertSeparator()">‚Äï Íµ¨Î∂ÑÏÑ†</button></div>
            </div>
            <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="handleImage(this)">

            <input type="text" id="titleInput" placeholder="Ï†úÎ™©">
            
            <div id="previewBox" class="preview-box" style="display:none; position:relative; margin-bottom:15px;">
                <img id="imgPreview" src="" style="max-width:100%; border-radius:8px;">
                <button onclick="removeImage()" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer;">X</button>
            </div>

            <div id="contentInput" contenteditable="true" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></div>

            <div class="editor-actions">
                <button class="btn btn-save" onclick="saveEntry()" style="width:100%;">Ï†ÄÏû•ÌïòÍ∏∞</button>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨</h3>
                <button class="btn-close-modal" onclick="closeModal()">‚úï</button>
            </div>
            <div class="cat-list" id="catManagerList"></div>
            <div class="modal-input-area">
                <input type="text" id="newCatName" class="input-new-cat" placeholder="ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨">
                <button class="btn-add-cat" onclick="addRootCategory()">Ï∂îÍ∞Ä</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. Ïû†Í∏à Î∞è Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï ---
        const SECRET_CODE = "003170"; // ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï (Ï¥àÍ∏∞ÏΩîÎìú)
        let isLocked = true;

        let diaries = JSON.parse(localStorage.getItem('myDiaries')) || [];
        let categories = JSON.parse(localStorage.getItem('myCategories')) || [
            { id: 'def_1', name: 'ÏùºÏÉÅ', parentId: null },
            { id: 'def_2', name: 'ÏÉùÍ∞Å', parentId: null }
        ];

        let currentFilterCat = 'ALL';
        let editingId = null; 
        let currentImgData = null;

        // --- 1. Ïû†Í∏à Í∏∞Îä• ---
        function checkCode() {
            const input = document.getElementById('unlockCode').value;
            if(input === SECRET_CODE) {
                isLocked = false;
                document.getElementById('sidebarLockArea').style.display = 'none';
                document.getElementById('sidebarContent').style.display = 'flex';
                document.getElementById('mainLockCover').style.display = 'none';
                renderSidebar();
                renderCardList('ALL');
            } else {
                alert('ÏΩîÎìúÍ∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                document.getElementById('unlockCode').value = '';
            }
        }

        // --- 2. Í∏∞Î≥∏ UI ÎèôÏûë ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.querySelector('.sidebar-overlay');
            if(sb.classList.contains('open')) {
                sb.classList.remove('open');
                ov.style.display = 'none';
            } else {
                sb.classList.add('open');
                ov.style.display = 'block';
            }
        }

        function switchView(mode) {
            document.querySelectorAll('.view-container').forEach(el => el.style.display = 'none');
            document.getElementById('listView').style.display = 'none';
            
            if(mode === 'list') {
                document.getElementById('listView').style.display = 'block';
            } else {
                document.getElementById(mode + 'View').style.display = 'block';
            }
            // Î™®Î∞îÏùº ÏÇ¨Ïù¥ÎìúÎ∞î Îã´Í∏∞
            document.getElementById('sidebar').classList.remove('open');
            document.querySelector('.sidebar-overlay').style.display = 'none';
        }

        function goBackToList() { switchView('list'); }

        // --- 3. ÏóêÎîîÌÑ∞ Í∏∞Îä• ---
        function execCmd(cmd, val) { 
            document.execCommand(cmd, false, val); 
        }
        function insertSeparator() { 
            // Íµ¨Î∂ÑÏÑ† Ïä§ÌÉÄÏùº Íπ®Ïßê Î∞©ÏßÄÎ•º ÏúÑÌï¥ Î™ÖÏãúÏ†Å Ïä§ÌÉÄÏùº Ìè¨Ìï®
            const hrHtml = '<hr style="border:0; border-top:1px solid #e0e0e0; margin:20px 0;">';
            document.execCommand('insertHTML', false, hrHtml); 
        }

        function createNewPost() {
            editingId = null; currentImgData = null;
            document.getElementById('titleInput').value = ''; 
            document.getElementById('contentInput').innerHTML = ''; 
            removeImage(); updateCategorySelectOptions();
            switchView('editor');
        }

        function saveEntry() {
            const title = document.getElementById('titleInput').value.trim();
            if(!title) return alert('Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');

            const now = new Date();
            const entry = {
                id: editingId || now.getTime(),
                timestamp: now.getTime(),
                title: title,
                content: document.getElementById('contentInput').innerHTML, 
                categoryId: document.getElementById('categorySelect').value,
                image: currentImgData
            };

            if(editingId) {
                const idx = diaries.findIndex(d => d.id === editingId);
                diaries[idx] = entry;
            } else {
                diaries.push(entry);
                editingId = entry.id;
            }
            localStorage.setItem('myDiaries', JSON.stringify(diaries));
            renderSidebar();
            alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
            openViewer(entry.id);
        }

        function openViewer(id) {
            const entry = diaries.find(d => d.id === id);
            if(!entry) return;
            editingId = entry.id;

            const cat = categories.find(c => c.id === entry.categoryId);
            document.getElementById('readCategory').innerText = cat ? cat.name : "ÎØ∏Î∂ÑÎ•ò";
            document.getElementById('readTitle').innerText = entry.title;
            
            const dObj = new Date(entry.timestamp);
            document.getElementById('readMeta').innerText = dObj.toLocaleDateString() + ' ' + dObj.toLocaleTimeString();
            document.getElementById('readContent').innerHTML = entry.content;
            
            if(entry.image) {
                document.getElementById('readImage').src = entry.image;
                document.getElementById('readImageContainer').style.display = 'block';
            } else {
                document.getElementById('readImageContainer').style.display = 'none';
            }
            switchView('read');
        }

        function editCurrentEntry() {
            const entry = diaries.find(d => d.id === editingId);
            if(!entry) return;
            document.getElementById('titleInput').value = entry.title;
            document.getElementById('contentInput').innerHTML = entry.content;
            updateCategorySelectOptions();
            document.getElementById('categorySelect').value = entry.categoryId || '';
            if(entry.image) {
                currentImgData = entry.image;
                document.getElementById('imgPreview').src = entry.image;
                document.getElementById('previewBox').style.display = 'block';
            }
            switchView('editor');
        }

        function deleteCurrentEntry() {
            if(confirm('Ï†ïÎßê ÏÇ≠Ï†úÌï†ÍπåÏöî?')) {
                diaries = diaries.filter(d => d.id !== editingId);
                localStorage.setItem('myDiaries', JSON.stringify(diaries));
                renderSidebar(); renderCardList('ALL'); goBackToList();
            }
        }

        // [Î∞±ÏóÖ Í∏∞Îä•] ÌååÏùº Ï†ÄÏû• (Ïä§ÌÉÄÏùº ÎÇ¥Ïû•Ìòï)
        function downloadEntryHTML() {
            const entry = diaries.find(d => d.id === editingId);
            if(!entry) return;

            const htmlContent = `
            <!DOCTYPE html>
            <html lang="ko">
            <head>
                <meta charset="UTF-8">
                <title>${entry.title}</title>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
                <style>
                    body { font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.8; color: #333; }
                    h1 { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 10px; }
                    .meta { color: #888; font-size: 14px; margin-bottom: 40px; }
                    .content { white-space: pre-wrap; word-break: break-word; }
                    hr { border: 0; border-top: 1px solid #e0e0e0; margin: 30px 0; }
                    img { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px 0; }
                </style>
            </head>
            <body>
                <h1>${entry.title}</h1>
                <div class="meta">${new Date(entry.timestamp).toLocaleString()}</div>
                <div class="content">
                    ${entry.image ? `<img src="${entry.image}"><br>` : ''}
                    ${entry.content}
                </div>
            </body>
            </html>`;
            
            const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${entry.title}.html`;
            a.click();
        }

        // --- 4. Î†åÎçîÎßÅ Ìó¨Ìçº ---
        function renderSidebar() {
            if(isLocked) return; // Ïû†Í∏à ÏÉÅÌÉúÎ©¥ Î†åÎçîÎßÅ ÏïàÌï®
            const nav = document.getElementById('sidebarNav'); nav.innerHTML = '';
            addNavItem(nav, 'Ï†ÑÏ≤¥ Î≥¥Í∏∞', diaries.length, 'ALL');
            
            categories.filter(c => !c.parentId).forEach(root => {
                const count = diaries.filter(d => d.categoryId === root.id).length;
                addNavItem(nav, root.name, count, root.id);
                
                categories.filter(c => c.parentId === root.id).forEach(child => {
                    const cCount = diaries.filter(d => d.categoryId === child.id).length;
                    addNavItem(nav, `‚îî ${child.name}`, cCount, child.id, true);
                });
            });
        }

        function addNavItem(parent, name, count, id, isSub=false) {
            const li = document.createElement('li');
            li.className = `nav-item ${isSub?'nav-sub':''} ${currentFilterCat===id?'active':''}`;
            li.innerHTML = `<span>${name}</span><span style="font-size:11px; color:#ccc">${count}</span>`;
            li.onclick = () => { currentFilterCat = id; renderSidebar(); renderCardList(id); toggleSidebar(); switchView('list'); };
            parent.appendChild(li);
        }

        function renderCardList(catId) {
            if(isLocked) return;
            const container = document.getElementById('cardContainer'); container.innerHTML = '';
            const catName = catId==='ALL' ? "Ï†ÑÏ≤¥ Î≥¥Í∏∞" : (categories.find(c=>c.id===catId)||{}).name;
            document.getElementById('listTitle').innerText = catName || "Î™©Î°ù";
            
            let list = catId==='ALL' ? diaries : diaries.filter(d => d.categoryId === catId);
            list.sort((a,b) => b.timestamp - a.timestamp);
            document.getElementById('emptyListState').style.display = list.length?'none':'block';
            
            list.forEach(d => {
                const dateStr = new Date(d.timestamp).toLocaleDateString();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = d.content;
                const cleanText = tempDiv.textContent || "";
                
                const card = document.createElement('div'); card.className = 'card';
                card.onclick = () => openViewer(d.id);
                card.innerHTML = `<div class="card-meta"><span>${dateStr}</span></div><div class="card-title">${d.title}</div><div class="card-preview">${cleanText}</div>`;
                container.appendChild(card);
            });
        }

        function handleImage(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxW = 800; let w=img.width, h=img.height;
                    if(w>maxW){ h*=maxW/w; w=maxW; }
                    canvas.width=w; canvas.height=h;
                    canvas.getContext('2d').drawImage(img,0,0,w,h);
                    currentImgData = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('imgPreview').src = currentImgData;
                    document.getElementById('previewBox').style.display = 'block';
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file); input.value = '';
        }
        function removeImage() { currentImgData = null; document.getElementById('previewBox').style.display = 'none'; }

        // --- 5. Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨ (ÏÉÅÏÑ∏ Í∏∞Îä• Î≥µÍµ¨) ---
        function updateCategorySelectOptions() {
            const sel = document.getElementById('categorySelect'); sel.innerHTML = '';
            categories.filter(c=>!c.parentId).forEach(r => {
                const opt = document.createElement('option'); opt.value = r.id; opt.innerText = r.name; sel.appendChild(opt);
                categories.filter(c=>c.parentId===r.id).forEach(ch => {
                    const sub = document.createElement('option'); sub.value = ch.id; sub.innerText = `  ‚îî ${ch.name}`; sel.appendChild(sub);
                });
            });
        }
        
        function openCategoryModal() { document.getElementById('modalOverlay').style.display = 'flex'; renderCatManager(); }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; renderSidebar(); updateCategorySelectOptions(); }
        
        function renderCatManager() {
            const list = document.getElementById('catManagerList'); list.innerHTML = '';
            
            categories.filter(c=>!c.parentId).forEach(r => {
                const row = document.createElement('div'); row.className = 'cat-row';
                row.innerHTML = `
                    <strong>${r.name}</strong>
                    <div class="cat-btn-group">
                        <button class="btn-cat-action" onclick="addChildCat('${r.id}')">ÏÜåÎ∂ÑÎ•ò</button>
                        <button class="btn-cat-action" onclick="editCat('${r.id}')">ÏàòÏ†ï</button>
                        <button class="btn-cat-action" onclick="delCat('${r.id}')">ÏÇ≠Ï†ú</button>
                    </div>`;
                list.appendChild(row);
                
                categories.filter(c=>c.parentId===r.id).forEach(ch => {
                    const sub = document.createElement('div'); sub.className = 'cat-row'; sub.style.paddingLeft='20px';
                    sub.innerHTML = `
                        <span style="color:#666">‚îî ${ch.name}</span>
                        <div class="cat-btn-group">
                            <button class="btn-cat-action" onclick="editCat('${ch.id}')">ÏàòÏ†ï</button>
                            <button class="btn-cat-action" onclick="delCat('${ch.id}')">ÏÇ≠Ï†ú</button>
                        </div>`;
                    list.appendChild(sub);
                });
            });
        }

        function addRootCategory() {
            const name = document.getElementById('newCatName').value.trim();
            if(name) { categories.push({id:'cat_'+Date.now(), name:name, parentId:null}); saveCat(); document.getElementById('newCatName').value=''; }
        }
        function addChildCat(parentId) {
            const name = prompt('ÏÜåÎ∂ÑÎ•ò Ïù¥Î¶Ñ:');
            if(name) { categories.push({id:'cat_'+Date.now(), name:name, parentId:parentId}); saveCat(); }
        }
        function editCat(id) {
            const cat = categories.find(c=>c.id===id);
            const newName = prompt('ÏàòÏ†ïÌï† Ïù¥Î¶Ñ:', cat.name);
            if(newName) { cat.name = newName; saveCat(); }
        }
        function delCat(id) {
            if(confirm('Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÇ≠Ï†úÌï†ÍπåÏöî? (Ìè¨Ìï®Îêú Í∏ÄÏùÄ ÎØ∏Î∂ÑÎ•òÍ∞Ä Îê©ÎãàÎã§)')) {
                // ÏûêÏãù Ïπ¥ÌÖåÍ≥†Î¶¨ÎèÑ ÏÇ≠Ï†ú
                categories = categories.filter(c => c.id !== id && c.parentId !== id);
                saveCat();
            }
        }
        function saveCat() {
            localStorage.setItem('myCategories', JSON.stringify(categories));
            renderCatManager();
        }
    </script>
</body>
</html>